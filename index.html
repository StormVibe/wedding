<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Wedding Invitation">
  <title>Divna & Nick Wedding Invite</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>

<nav>
  <ul>
    <li><a href="https://divna-nick.org/">Home</a></li>
    <li><a href="https://divna-nick.org/#wedding-details">Wedding Ceremony</a></li>
    <li><a href="https://divna-nick.org/#reception-details">Reception</a></li>
    <li><a href="https://divna-nick.org/photos">Pictures</a></li>
    <li><a href="https://divna-nick.org/wedding">Orthodox Wedding</a></li>
    <li><a href="https://divna-nick.org/#rsvp">RSVP</a></li>
  </ul>
</nav>

<header>
  <h1>Wedding Invitation</h1>
  <p>We are so excited to share this special day with you!</p>

  <section id="couple-intro">
    <button onclick="document.getElementById('rsvp').scrollIntoView({behavior:'smooth'})">
      RSVP Now
    </button>
    <h3 id="countdown">Loading countdown...</h3>
    <div id="couple-photo">
      <img src="couple-photo.jpg" alt="Divna & Nick">
    </div>
    <p><strong>Divna & Nick</strong> invite you to celebrate their wedding!</p>
  </section>
</header>

<section id="wedding-details">
  <h2>The Wedding Ceremony</h2>
  <p><strong>Date:</strong> Sunday, April 19, 2026 at 3:30 PM</p><br>
  <p><strong>Location:</strong> St Gregory of Nyssa Orthodox Christian Church<br> 2219 Summit St. Columbus, Ohio </p>
  <div class="directions">
	<a href="https://www.google.com/maps/place/?q=place_id:ChIJF3ld-66OOIgRk9w2QbjoCXI" target="_blank">
    Get Directions
	</a>
  </div>
</section>

<section id="reception-details">
  <h2>The Reception</h2>
  <p><strong>Date:</strong> Sunday, April 19, 2026 at 5:00 PM to 8:30 PM</p><br><br>
  <p><strong>Location:</strong> TBD <br><br>
    <a href="#rsvp">RSVP</a> or <a href="mailto:rsvp@divna-nick.org">contact us</a> for updates!</p>
</section>

<section id="rsvp">
  <h2>RSVP</h2>

  <form id="rsvp-form">
    
    <!-- Email Updates Selection -->
    <label class="email-opt-in">Would you like to receive email updates?</label>
    <select id="email-opt-in" name="entry.mailto" required>
      <option value="" selected >Select</option>
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <!-- Email Field (Hidden by Default) -->
    <div id="email-wrapper">
      <label>Email</label>
      <input type="email" id="email-field" name="entry.email">
    </div>

    <!-- Name Field -->
    <label>Name</label>
    <input type="text" name="entry.name" required>

    <!-- Guest Number Field -->
    <label>Number of Guests</label>
    <input type="number" name="entry.guest" min="1" required>

    <!-- Dietary Needs Field -->
    <label>Dietary Needs</label>
    <select name="entry.diet" required>
      <option value="none">None</option>
      <option value="gluten-free">Gluten-Free</option>
      <option value="vegetarian">Vegetarian</option>
      <option value="vegan">Vegan</option>
    </select>

    <!-- Invite Code Field -->
    <label>Invite Code</label>
    <input type="text" name="entry.invite" required>

    <!-- Submit Button -->
    <button type="submit">Submit RSVP</button>
  </form>

  <!-- RSVP Message (Display After Submission) -->
  <div id="rsvp-message"></div>
</section>

<!-- Calendar Modal -->
<div id="calendar-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>RSVP confirmed! Add this event to your calendar?</h3>
    <div class="calendar-buttons">
      <button id="download-ics">Download ICS</button>
      <button id="open-google">Open Google Calendar</button>
      <button id="calendar-no">No Thanks</button>
    </div>
  </div>
</div>

<footer>
  <p>&copy; 2026 Divna & Nick</p>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const APP_SCRIPT_URL =
    'https://script.google.com/macros/s/AKfycbzPwSR7w53y8OZX0LSeNPbVBgLb0H61Q_cbLvjpbSCqhvnbx6-uBEA-izIx5j9EOwu_/exec';

  /* ========= JWT ========= */

  async function fetchJWT(inviteCode) {
    const url =
      `${APP_SCRIPT_URL}?action=jwt&invite=${encodeURIComponent(inviteCode)}`;

    const res = await fetch(url);
    const data = await res.json();

    if (!data.token) {
      throw new Error(data.error || 'JWT issuance failed');
    }

    return data.token;
  }

  /* ========= MODAL ========= */

  const modal = document.getElementById('calendar-modal');

  function showCalendarModal() {
    modal.style.display = 'flex';
  }

  function closeCalendarModal() {
    modal.style.display = 'none';
  }

  /* ========= CALENDAR ========= */

  function downloadCalendarICS() {
    const ics =
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Wedding Invitation//EN
CALSCALE:GREGORIAN
BEGIN:VEVENT
UID:wedding-${Date.now()}@example.com
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z
DTSTART:20260419T153000
DTEND:20260419T090000
SUMMARY:Divna & Nick's Wedding
DESCRIPTION:We can't wait to celebrate with you!
LOCATION:2219 Summit St Columbus, Ohio
END:VEVENT
END:VCALENDAR`;

    const blob = new Blob([ics.replace(/\n/g, '\r\n')], {
      type: 'text/calendar;charset=utf-8'
    });

    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'Wedding.ics';
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function openGoogleCalendar() {
    const url =
      'https://www.google.com/calendar/render?action=TEMPLATE' +
      '&text=' + encodeURIComponent("Divna & Nick's Wedding") +
      '&dates=20260419T153000/20260419T210000' +
      '&details=' + encodeURIComponent("We can't wait to celebrate with you!") +
      '&location=' + encodeURIComponent("2219 Summit St Columbus, Ohio");

    window.open(url, '_blank');
  }

  /* ========= RSVP ========= */

  document.getElementById('rsvp-form')
    .addEventListener('submit', async e => {
      e.preventDefault();

      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const msg = document.getElementById('rsvp-message');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      msg.textContent = 'Securing your invitation...';

      try {
        const formData = new FormData(form);
        const invite = formData.get('entry.invite');

        const jwt = await fetchJWT(invite);
        formData.append('jwt', jwt);

        msg.textContent = 'Saving your RSVP...';

        const res = await fetch(APP_SCRIPT_URL, {
          method: 'POST',
          body: formData
        });

        const data = await res.json();

        if (data.result === 'success') {
          msg.textContent = 'RSVP submitted successfully! Check your email in 5 minutes (might show up in spam)';
          form.reset();
          showCalendarModal();

          submitBtn.textContent = 'RSVP Submitted';
        } else {
          msg.textContent = 'Error: ' + data.message;

          if (
            data.message === 'Missing invite' ||
            data.message === 'Server error'
          ) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit RSVP';
          }
        }

      } catch (err) {
        const errorMsg = err.message || 'Server error';
        msg.textContent = errorMsg;

        if (
          errorMsg === 'Missing invite' ||
          errorMsg === 'Server error'
        ) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit RSVP';
        }
      }
    });


  document.getElementById('download-ics').onclick = () => {
    downloadCalendarICS();
    closeCalendarModal();
  };

  document.getElementById('open-google').onclick = () => {
    openGoogleCalendar();
    closeCalendarModal();
  };

  document.getElementById('calendar-no').onclick = closeCalendarModal;

});
const emailOpt = document.getElementById('email-opt-in');
const emailWrap = document.getElementById('email-wrapper');
const emailField = document.getElementById('email-field');

emailOpt.addEventListener('change', () => {
  if (emailOpt.value === 'yes') {
    emailWrap.style.display = 'block';
    emailField.required = true;
  } else {
    emailWrap.style.display = 'none';
    emailField.required = false;
    emailField.value = '';
  }
});

document.getElementById('email-opt-in').addEventListener('change', function () {
  const emailWrapper = document.getElementById('email-wrapper');
  const emailOptIn = this.value;
  
  if (emailOptIn === 'yes') {
    emailWrapper.style.display = 'block';
  } else {
    emailWrapper.style.display = 'none';
  }
});


/* ========= COUNTDOWN ========= */

const weddingDate = new Date('2026-04-19T15:30:00'); // actual ceremony time
const countdownEl = document.getElementById('countdown');

if (countdownEl) {
  const now = new Date();

  const diffTime = weddingDate - now; // difference in milliseconds
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

  if (diffTime > 0) {
    // wedding is in the future
    if (diffDays > 1) {
      countdownEl.innerHTML = `<span>${diffDays}</span> days to go`;
    } else if (diffDays === 1) {
      countdownEl.innerHTML = `<span>1</span> day to go`;
    } else {
      // less than 1 day remaining
      countdownEl.innerHTML = `üéâ <span>Today‚Äôs the day!</span> üéâ`;
    }
  } else {
    // wedding has passed
    countdownEl.innerHTML = `üíç <span>Just Married</span> üíç`;
  }
}

</script>

</body>
</html>
